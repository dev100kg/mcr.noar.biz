---
import type { LinkItem } from '../types/content';

interface Props {
  title: string;
  description?: string;
  items: LinkItem[];
  variant?: 'default' | 'highlight' | 'muted';
}

const { title, description, items, variant } = Astro.props as Props;

const sectionVariant = variant ?? 'default';

// enabled=false を除外（省略は true 扱い）
const visibleItems = items.filter((it) => it.enabled !== false);
const linkLabelText = '件';

const formatUrl = (url: string) => {
  try {
    const parsed = new URL(url);
    const path = parsed.pathname === '/' ? '' : parsed.pathname.replace(/\/$/, '');
    return `${parsed.hostname}${path}`;
  } catch {
    return url;
  }
};

const isHighlight = sectionVariant === 'highlight';
const isMuted = sectionVariant === 'muted';

const countBadgeClass = [
  'shrink-0 rounded-full px-3.5 py-1.5 text-sm font-semibold ring-1 flex items-center gap-1.5 tabular-nums leading-none',
  isHighlight
    ? 'bg-brand text-white ring-brand-dark/35 shadow-[0_8px_18px_rgba(30,127,79,0.24)]'
    : isMuted
      ? 'bg-brand/92 text-white ring-brand-dark/32'
      : 'bg-brand/85 text-white ring-brand-dark/24',
].join(' ');

const cardBaseClass = [
  'group block rounded-2xl border bg-white/76 p-4 transition duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-dark',
  isHighlight
    ? 'border-brand/22 bg-white/94 shadow-[0_10px_24px_rgba(30,127,79,0.08)] hover:-translate-y-0.5 hover:border-brand/34 hover:bg-[#f4fbf7] hover:shadow-[0_14px_28px_rgba(30,127,79,0.12)] focus-visible:bg-[#f4fbf7] focus-visible:shadow-[0_14px_28px_rgba(30,127,79,0.14)]'
    : isMuted
      ? 'border-brand/14 bg-white/86 hover:-translate-y-0.5 hover:border-brand/26 hover:bg-[#f7fbf9] hover:shadow-[0_10px_22px_rgba(30,127,79,0.1)] focus-visible:bg-[#f7fbf9] focus-visible:shadow-[0_10px_22px_rgba(30,127,79,0.11)]'
      : 'border-brand/16 bg-white/90 hover:-translate-y-0.5 hover:border-brand/28 hover:bg-[#f5faf8] hover:shadow-[0_12px_24px_rgba(30,127,79,0.12)] focus-visible:bg-[#f5faf8] focus-visible:shadow-[0_12px_24px_rgba(30,127,79,0.13)]',
].join(' ');

const labelClass =
  'truncate font-semibold text-brand-dark transition-colors group-hover:text-brand group-focus-visible:text-brand group-hover:underline group-focus-visible:underline group-hover:underline-offset-4 group-focus-visible:underline-offset-4';
const metaTextClass = 'text-stone-500';
const arrowClass =
  'mt-0.5 text-base text-brand transition duration-200 group-hover:translate-x-0.5 group-hover:-translate-y-0.5 group-focus-visible:translate-x-0.5 group-focus-visible:-translate-y-0.5';

const getTagClass = (index: number) => {
  const tones = [
    'border-brand/32 bg-brand/16 text-brand-dark',
    'border-brand/24 bg-brand/10 text-brand-dark/95',
    'border-brand/18 bg-brand-soft/60 text-brand-dark/90',
  ];
  const tone = tones[Math.min(index, tones.length - 1)];

  return `inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-medium transition ${tone} group-hover:border-brand/36 group-focus-visible:border-brand/36`;
};
---

<section
  class={`section-panel section-rise p-5 sm:p-6 ${
    sectionVariant === 'highlight'
      ? 'border-brand/16 bg-[var(--bg-soft)]'
      : isMuted
        ? 'border-brand/12 bg-white/86'
        : 'border-brand/12 bg-white/90'
  }`}
>
  <header class="mb-5 flex items-start justify-between gap-4">
    <div>
      <h2 class="hero-display text-[1.05rem] font-semibold tracking-[0.01em] text-brand-dark sm:text-xl">
        {title}
      </h2>
      {description && <p class="mt-1.5 text-sm leading-relaxed text-stone-600">{description}</p>}
    </div>

    <span class={countBadgeClass}>
      <span class="text-sm font-semibold tabular-nums">{visibleItems.length}</span>
      <span class="text-[0.68rem] font-medium text-white/90 sm:text-xs">{linkLabelText}</span>
    </span>
  </header>

  {
    visibleItems.length === 0 ? (
      <div class="rounded-xl border border-brand/14 bg-white/90 p-4 text-sm text-stone-600">
        現在、募集中の求人はありません。
      </div>
    ) : (
      <ul class="flex flex-col gap-3.5">
        {visibleItems.map((it) => (
          <li>
            <a
              href={it.url}
              target="_blank"
              rel="noopener noreferrer nofollow"
              class={cardBaseClass}
              title={it.url}
            >
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class={labelClass}>{it.label}</div>

                  {it.note && <div class="mt-1 text-sm text-stone-600">{it.note}</div>}

                  {it.tags && it.tags.length > 0 && (
                    <div class="mt-2 flex flex-wrap gap-2">
                      {it.tags.map((tag, index) => (
                        <span class={getTagClass(index)}>
                          {tag}
                        </span>
                      ))}
                    </div>
                  )}
                </div>

                <span class={arrowClass} aria-hidden="true">
                  ↗
                </span>
              </div>

              <div class={`mt-3 text-xs w-full truncate ${metaTextClass}`}>{formatUrl(it.url)}</div>
            </a>
          </li>
        ))}
      </ul>
    )
  }
</section>
